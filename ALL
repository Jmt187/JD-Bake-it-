/**************************************************************************
 Combined Score Counter with Audio Feedback
 For ATMega328P Microcontroller
 **************************************************************************/

#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <SoftwareSerial.h>
#include "DFRobotDFPlayerMini.h"

// LCD Configuration (adjust address if needed - common addresses are 0x27 or 0x3F)
#define LCD_ADDRESS 0x27       
#define LCD_COLUMNS 16         
#define LCD_ROWS 2             

LiquidCrystal_I2C lcd(LCD_ADDRESS, LCD_COLUMNS, LCD_ROWS);

// DFPlayer Configuration
#define DFPLAYER_RX 9          
#define DFPLAYER_TX 10         
SoftwareSerial dfPlayerSerial(DFPLAYER_RX, DFPLAYER_TX);
DFRobotDFPlayerMini myDFPlayer;

// Pin Definitions
#define ROTARY_POT_PIN A3      
#define SLIDE_POT_PIN A2       
#define LED1 8                 
#define LED2 7                 
#define BUTTON_PIN 2           

// Threshold values for analog inputs
#define ROTARY_THRESHOLD 300   
#define SLIDE_THRESHOLD 300    

// Debouncing
#define DEBOUNCE_DELAY 20      

// Button state variables
int buttonState;               
int lastButtonState = HIGH;    
unsigned long lastDebounceTime = 0;  

// Analog input state tracking
bool rotaryTriggered = false;  
bool slideTriggered = false;   

// Score variable
int score = 0;                 

// Audio playback control
bool dfPlayerReady = false;    
unsigned long lastAudioTime = 0;
#define AUDIO_COOLDOWN 500     

void setup() {
  Serial.begin(115200);
  Serial.println(F("Score Counter with Audio System"));
  
  // Configure pins
  pinMode(LED1, OUTPUT);
  pinMode(LED2, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(ROTARY_POT_PIN, INPUT);
  pinMode(SLIDE_POT_PIN, INPUT);
  
  // Initialize LCD
  Wire.begin();
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Initializing...");
  
  // Initialize DFPlayer Mini
  dfPlayerSerial.begin(9600);
  delay(1000);
  
  if (!myDFPlayer.begin(dfPlayerSerial, true, true)) {
    Serial.println(F("DFPlayer failed - check SD card"));
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Audio: ERROR");
    delay(3000);
    dfPlayerReady = false;
  } else {
    Serial.println(F("DFPlayer Mini online"));
    myDFPlayer.volume(25);  // Volume 0-30
    dfPlayerReady = true;
  }
  
  // Display initial score
  displayScore();
  Serial.println(F("System Ready!"));
}

void loop() {
  handleButton();
  handleRotaryPot();
  handleSlidePot();
  
  if (dfPlayerReady && myDFPlayer.available()) {
    printDFPlayerDetail(myDFPlayer.readType(), myDFPlayer.read());
  }
}

void handleButton() {
  int reading = digitalRead(BUTTON_PIN);
  
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }
  
  if ((millis() - lastDebounceTime) > DEBOUNCE_DELAY) {
    if (reading != buttonState) {
      buttonState = reading;
      
      if (buttonState == LOW) {
        score++;
        displayScore();
        playScoreSound();
        Serial.print(F("Button pressed! Score: "));
        Serial.println(score);
      }
    }
  }
  
  lastButtonState = reading;
}

void handleRotaryPot() {
  int rotaryValue = analogRead(ROTARY_POT_PIN);
  
  if (rotaryValue > ROTARY_THRESHOLD && !rotaryTriggered) {
    score++;
    rotaryTriggered = true;
    
    digitalWrite(LED1, HIGH);
    delay(100);
    digitalWrite(LED1, LOW);
    
    displayScore();
    playScoreSound();
    
    Serial.print(F("Rotary Pot: "));
    Serial.println(score);
  } 
  else if (rotaryValue <= ROTARY_THRESHOLD) {
    rotaryTriggered = false;
  }
}

void handleSlidePot() {
  int slideValue = analogRead(SLIDE_POT_PIN);
  
  if (slideValue > SLIDE_THRESHOLD && !slideTriggered) {
    score++;
    slideTriggered = true;
    
    digitalWrite(LED2, HIGH);
    delay(100);
    digitalWrite(LED2, LOW);
    
    displayScore();
    playScoreSound();
    
    Serial.print(F("Slide Pot: "));
    Serial.println(score);
  } 
  else if (slideValue <= SLIDE_THRESHOLD) {
    slideTriggered = false;
  }
}

void displayScore() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Score:");
  lcd.setCursor(0, 1);
  lcd.print(score);
}

void playScoreSound() {
  if (!dfPlayerReady) return;
  
  unsigned long currentTime = millis();
  if (currentTime - lastAudioTime < AUDIO_COOLDOWN) return;
  lastAudioTime = currentTime;
  
  myDFPlayer.play(1);  // Plays 0001.mp3
}

void printDFPlayerDetail(uint8_t type, int value) {
  switch (type) {
    case TimeOut:
      Serial.println(F("DFPlayer: Time Out!"));
      break;
    case DFPlayerCardRemoved:
      Serial.println(F("DFPlayer: Card Removed!"));
      dfPlayerReady = false;
      break;
    case DFPlayerCardOnline:
      Serial.println(F("DFPlayer: Card Online!"));
      dfPlayerReady = true;
      break;
    case DFPlayerError:
      Serial.print(F("DFPlayer Error: "));
      if (value == Busy) {
        Serial.println(F("Card not found"));
        dfPlayerReady = false;
      }
      break;
  }
}
